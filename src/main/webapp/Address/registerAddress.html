<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Register</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
<style type="text/css">
	body {
		background-color: gray;
		align-items: center;		
	}
	button {
		color: black;
	}	
	#page {
		margin: auto;
		background-color: white;
		box-shadow: 10px 10px 10px 10px black;
		border: 2px black solid;
		border-radius: 10px;
		text-align: center;
		width: 70%;
		height: 100%;
	}
</style>
</head>
<body>
	<div id="page">
		<h1>Address Register</h1>
		<form method="post" action="/MVC_WEB/AddressAPI">			
			<p>
				<label for="addr_userId">User ID:</label>
				<input type="number" id="addr_userId" name="addr_userId" required disabled>
			</p>	
			<p>
				<label for="addr_cep">CEP:</label>
				<input type="text" id="addr_cep" name="addr_cep" placeholder="01234-567" required onchange="findAddrs()" 
					maxlength="9">
			</p>	
			<p>
				<label for="addr_street">Street:</label>
				<input type="text" id="addr_street" name="addr_street" placeholder="Name of Street" required>
			</p>
			<p>
				<label for="addr_number">Number:</label>
				<input type="number" id="addr_number" name="addr_number" required>
			</p>
			<p>
				<label for="addr_city">City:</label>
				<input type="text" id="addr_city" name="addr_city" placeholder="Name of City" required>
			</p>
			<p>
				<label for="addr_state">State:</label>
				<input type="text" id="addr_state" name="addr_state" placeholder="Name of State" required></input>
			</p>
			<p>
				<label for=addr_country>Country:</label>
				<input type="text" id="addr_country" name="addr_country" placeholder="Name of Country" required></input>
			</p>
			<p>						
				<input type="submit" value="Register" onclick="ableUserId('addr_userId')">				
				<button><a href="/MVC_WEB/home.html" style="text-decoration: none; color: black;">Cancel</a></button>						
			</p>			
		</form>	
	</div>
</body>
<script type="text/javascript">
	setTimeout(updateHtml, 1);

	function updateHtml() {	
		var route = "/MVC_WEB/UserAPI?user_cpf=" + window.location.search.split('=')[1];
		
		$.ajax({url: route, method: "GET",
			success: function(response){
				checkAddress(response.User.id);
				document.getElementById("addr_userId").value = response.User.id;
			},
			error: function(){
				alert("User not found!");
				window.location.href = "/MVC_WEB/User/userConfig.html";
			}});
	}
	
	function checkAddress(userID){		
		var routerAddres = "/MVC_WEB/AddressAPI?addr_userId=" + userID;
		var routerUpdateAddress = "/MVC_WEB/Address/updateAddress.html?user_cpf=" + window.location.search.split('=')[1];
		
		$.ajax({url: routerAddres, method: "GET"})
			.done(function (response) {				
				var data = response;				
				if(data.Status == 200){					
					window.location.href = "/MVC_WEB/User/userConfig.html";
				}
			})
	}
	
	function getCEP(cep){
		cep = cep.replaceAll("-", "")
		if(cep.length >= 5) return cep.substr(0, 5) + "-" + cep.substr(5);			
		else return cep;
	}
	
	function ableUserId(id){
		document.getElementById(id).disabled = false;
	}
	
	function findAddrs(){
		var cepElement = document.getElementById("addr_cep");
		cepElement.value = getCEP(cepElement.value);
		console.log(cepElement.value);
		
		if(cepElement.value.length != 9){
			alert("CEP invalid");
			return;
		}
				
		$.ajax({
			url: "https://viacep.com.br/ws/" + cepElement.value + "/json",
			dataType: "json",
			crossDomain: "true",
			contentyType: "application/json",
			statusCode: {
				200: function(data){
					if(Object.keys(data).includes("erro") && data.erro == true){
						alert("CEP not Found!");
						return;
					}
					document.getElementById("addr_street").value = data.logradouro;
					document.getElementById("addr_city").value = data.localidade;
					document.getElementById("addr_state").value = data.uf;
					document.getElementById("addr_country").value = "Brazil";					
				},
				400: function(data){
					console.log(data)
					alert("CEP wrong - Brazil");
				},
				404: function(data){
					console.log(data);
					alert("CEP not found");
				}
			}
		});
	}
</script>
</html>
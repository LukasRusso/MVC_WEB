<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Update User</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
<style type="text/css">
	body {
		background-color: gray;
		align-items: center;		
	}
	button {
		color: black;
	}	
	#page {
		margin: auto;
		background-color: white;
		box-shadow: 10px 10px 10px 10px black;
		border: 2px black solid;
		border-radius: 10px;
		text-align: center;
		width: 70%;
		height: 100%;
	}
</style>
</head>
<body>
	<div id="page">
		<h1>Update Address</h1>
		<p>
			<label for="addr_id">Address ID:</label>
			<input type="number" id="addr_id" name="addr_id" required disabled>
		</p>
		<p>
			<label for="addr_userId">User ID:</label>
			<input type="number" id="addr_userId" name="addr_userId" required disabled>
		</p>	
		<p>
			<label for="addr_cep">CEP:</label>
			<input type="text" id="addr_cep" name="addr_cep" placeholder="01234-567" required onchange="findAddrs()" 
				maxlength="9">
		</p>	
		<p>
			<label for="addr_street">Street:</label>
			<input type="text" id="addr_street" name="addr_street" placeholder="Name of Street" required>
		</p>
		<p>
			<label for="addr_number">Number:</label>
			<input type="number" id="addr_number" name="addr_number" required>
		</p>
		<p>
			<label for="addr_city">City:</label>
			<input type="text" id="addr_city" name="addr_city" placeholder="Name of City" required>
		</p>
		<p>
			<label for="addr_state">State:</label>
			<input type="text" id="addr_state" name="addr_state" placeholder="Name of State" required></input>
		</p>
		<p>
			<label for=addr_country>Country:</label>
			<input type="text" id="addr_country" name="addr_country" placeholder="Name of Country" required></input>
		</p>
		<p>						
			<input type="submit" value="Register" onclick="ableUserId()">				
			<button><a href="/MVC_WEB/home.html" style="text-decoration: none; color: black;">Cancel</a></button>						
		</p>
	</div>
</body>
<script type="text/javascript">
	setTimeout(updateHtml, 1);
	
	function updateHtml() {	
		var routeUser = "/MVC_WEB/UserAPI?user_cpf=" + window.location.search.split('=')[1];
		var routerAddres = "/MVC_WEB/AddressAPI?addr_userId=";
				
		$.ajax({url: routeUser, method: "GET"})
			.done(function (response) {					
				var data = response;				
				if(data.Status == 200){				
					getAddress(data.User.id);
				}
				else{
					window.location.href = routerAddres;
				}
			})
	}
	
	function getAddress(userID){		
		var routerAddres = "/MVC_WEB/AddressAPI?addr_userId=" + userID;
		
		$.ajax({url: routerAddres, method: "GET"})
			.done(function (response) {				
				var data = response;				
				if(data.Status == 200){
					document.getElementById("addr_id").value = data.Address.addr_id;
					document.getElementById("addr_userId").value = data.Address.addr_userId;
					document.getElementById("addr_street").value = data.Address.addr_street;
					document.getElementById("addr_number").value = data.Address.addr_number;
					document.getElementById("addr_city").value = data.Address.addr_city;
					document.getElementById("addr_state").value = data.Address.addr_state;
					document.getElementById("addr_country").value = data.Address.addr_country;
					document.getElementById("addr_cep").value = data.Address.addr_cep;
				}
				else{
					window.location.href = routerAddres;
				}
			})
	}
	
	function updateAddress() {	
		var route = "/MVC_WEB/AddressAPI";
		var address = {
			"addr_id": document.getElementById("addr_id").value,		
			"addr_userId": document.getElementById("addr_userId").value,
			"addr_street": document.getElementById("addr_street").value,
			"addr_number": document.getElementById("addr_number").value,
			"addr_city": document.getElementById("addr_city").value,
			"addr_state": document.getElementById("addr_state").value,
			"addr_country": document.getElementById("addr_country").value,
			"addr_cep": document.getElementById("addr_cep").value
		};
		
		console.log(address);
		
		$.ajax({
			url: route, 
			headers: {"Content-Type":"application/json", "charset":"UTF-8"}, 
			method: "PUT", data: address,})
			.done(function(){
				window.location.href = route + "?addr_userId=" + address.addr_userId;
			});
	}
	
	function ableUserId(){
		document.getElementById("addr_id").disabled = false;
		document.getElementById("addr_userId").disabled = false;
		updateAddress();
	}
	
	function getCEP(cep){
		cep = cep.replaceAll("-", "")
		if(cep.length >= 5) return cep.substr(0, 5) + "-" + cep.substr(5);			
		else return cep;
	}
	
	function findAddrs(){
		var cepElement = document.getElementById("addr_cep");
		cepElement.value = getCEP(cepElement.value);
		console.log(cepElement.value);
		
		if(cepElement.value.length != 9){
			alert("CEP invalid");
			return;
		}
				
		$.ajax({
			url: "https://viacep.com.br/ws/" + cepElement.value + "/json",
			dataType: "json",
			crossDomain: "true",
			contentyType: "application/json",
			statusCode: {
				200: function(data){
					if(Object.keys(data).includes("erro") && data.erro == true){
						alert("CEP not Found!");
						return;
					}
						
					document.getElementById("addr_street").value = data.logradouro;
					document.getElementById("addr_city").value = data.localidade;
					document.getElementById("addr_state").value = data.uf;
					document.getElementById("addr_country").value = "Brazil";					
				},
				400: function(data){
					console.log(data)
					alert("CEP wrong - Brazil");
				},
				404: function(data){
					console.log(data);
					alert("CEP not found");
				}
			}
		});
	}
	
</script>
</html>